<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            color: #fff;
            transition: all 0.3s;
        }
        .dark-mode { 
            background: linear-gradient(to bottom, #2b2b2b, #1a1a1a); 
            color: #f4f4f4; 
        }
        .energy-theme { 
            background: url('https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed; 
            background-size: cover; 
        }
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; 
        }
        .modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; 
            box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3); display: none; z-index: 1050; 
            color: #333; 
        }
        .dark-mode .modal { background: rgba(66, 66, 66, 0.9); color: #f4f4f4; }
        .notification-modal { width: 300px; max-height: 200px; overflow-y: auto; }
        .small-modal { width: 350px; }
        .ha-sidebar { 
            width: 250px; background-color: #003366; color: white; position: fixed; height: 100vh; padding: 20px; z-index: 1000; transition: width 0.3s; 
        }
        .ha-sidebar.minimized { width: 60px; }
        .ha-sidebar.minimized .logo, .ha-sidebar.minimized .nav-link span, .ha-sidebar.minimized .btn span, .ha-sidebar.minimized .notification-icon span { display: none; }
        .ha-sidebar .logo { font-size: 1.5em; text-align: center; margin-bottom: 20px; }
        .ha-sidebar .nav-link { color: white; padding: 10px; display: flex; align-items: center; }
        .ha-sidebar .nav-link:hover { background: #004080; }
        .energy-theme .ha-sidebar .nav-link:hover { background: #388e3c; }
        .dark-mode .ha-sidebar { background-color: #212121; }
        .dark-mode .ha-sidebar .nav-link:hover { background: #424242; }
        .ha-sidebar .nav-link i { margin-right: 10px; }
        .ha-sidebar .minimize-icon { font-size: 1.5em; cursor: pointer; position: absolute; top: 10px; left: 10px; }
        .ha-sidebar .notification-icon { color: white; padding: 10px; display: flex; align-items: center; cursor: pointer; }
        .ha-sidebar .notification-icon:hover { background: #004080; }
        .energy-theme .ha-sidebar .notification-icon:hover { background: #388e3c; }
        .dark-mode .ha-sidebar .notification-icon:hover { background: #424242; }
        .dashboard { margin-left: 270px; padding: 20px; transition: margin-left 0.3s; }
        .dashboard.minimized { margin-left: 60px; }
        .dashboard-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; 
            background-color: #003366; color: #fff; position: sticky; top: 0; z-index: 1000; 
        }
        .energy-theme .dashboard-header { background-color: #2e7d32; }
        .dark-mode .dashboard-header { background-color: #212121; }
        .header-info { text-align: right; }
        .header-info .time { font-size: 1.5em; }
        .header-info .location { font-size: 1.2em; }
        .header-info i { font-size: 1.5em; cursor: pointer; margin-left: 15px; }
        .dashboard-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            padding: 20px; 
            justify-content: space-between; 
        }
        .chart-container { 
            margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.9); 
            border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            color: #333; 
            flex: 1 1 calc(33.33% - 20px); 
            min-width: 300px; 
        }
        .dark-mode .chart-container { background: rgba(66, 66, 66, 0.9); color: #f4f4f4; }
        .btn-primary { background-color: #00b4b4; border-color: #00b4b4; }
        .energy-theme .btn-primary { background-color: #4caf50; border-color: #4caf50; }
        .dark-mode .btn-primary { background-color: #0288d1; border-color: #0288d1; }
        .btn-danger { background-color: #d9534f; border-color: #d9534f; }
        canvas { width: 100%; max-height: 250px; }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .ha-sidebar {
                width: 60px;
            }
            .ha-sidebar .logo, .ha-sidebar .nav-link span, .ha-sidebar .btn span, .ha-sidebar .notification-icon span {
                display: none;
            }
            .dashboard {
                margin-left: 60px;
            }
            .dashboard-grid {
                flex-direction: column;
            }
            .chart-container {
                flex: 1 1 100%;
            }
        }

        @media (max-width: 576px) {
            body, .header-info .time, .header-info .location {
                font-size: 0.9em;
            }
            .chart-container {
                padding: 15px;
            }
            .modal, .small-modal, .notification-modal {
                width: 90%;
            }
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-info {
                text-align: left;
                margin-top: 10px;
            }
            .header-info i {
                margin-left: 10px;
                margin-right: 0;
            }
        }

        @media (min-width: 769px) {
            .ha-sidebar {
                width: 250px;
            }
            .dashboard {
                margin-left: 270px;
            }
        }
    </style>
</head>
<body onload="initEnergyPage()">
    <!-- Dashboard Page -->
    <div class="container-fluid dashboard-container">
        <!-- Sidebar -->
        <nav class="ha-sidebar" id="sidebar">
            <div class="minimize-icon" id="minimize-sidebar"><i class="fas fa-bars"></i></div>
            <div class="logo" data-i18n="smartHomeAssistant">Smart Home Assistant</div>
            <a href="index.html" class="nav-link" onclick="showHomePage(event)"><i class="fas fa-home"></i><span data-i18n="overview">Overview</span></a>
            <a href="#" class="nav-link active" onclick="showSection('energy-section')"><i class="fas fa-chart-bar"></i><span data-i18n="energy">Energy</span></a>
            <a href="#" class="nav-link" onclick="showSettings()"><i class="fas fa-cog"></i><span data-i18n="settings">Settings</span></a>
            <div class="notification-icon" onclick="toggleNotifications()"><i class="fas fa-bell"></i><span data-i18n="notifications">Notifications</span></div>
            <button class="btn btn-danger w-100 mt-3" onclick="logout()" data-i18n="logout"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
        </nav>

        <!-- Dashboard Content -->
        <div class="dashboard" id="dashboard-content">
            <div class="dashboard-header">
                <h1 class="h3 mb-0" data-i18n="energyDashboard">Energy Dashboard</h1>
                <div class="header-info">
                    <div class="location" id="header-location">Loading...</div>
                    <div class="time" id="header-time">Loading...</div>
                    <i class="fas fa-search" onclick="showSearchModal()"></i>
                    <i class="fas fa-edit" onclick="showEditModal()"></i>
                </div>
            </div>

            <div class="dashboard-grid" id="energy-section">
                <div class="chart-container">
                    <h3 data-i18n="electricUsage">Electric Usage (kWh)</h3>
                    <select onchange="updateChartPeriod('electricUsageChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="electricUsageChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="energyDistribution">Energy Distribution</h3>
                    <select onchange="updateChartPeriod('energyDistributionChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="energyDistributionChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="solarProduction">Solar Production (kWh)</h3>
                    <select onchange="updateChartPeriod('solarProductionChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="solarProductionChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="netConsumed">Net Consumed from Grid (kWh)</h3>
                    <select onchange="updateChartPeriod('netConsumedChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="netConsumedChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="selfConsumed">Self-Consumed Energy (kWh)</h3>
                    <select onchange="updateChartPeriod('selfConsumedChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="selfConsumedChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="solarEnergy">Solar Energy (kWh)</h3>
                    <select onchange="updateChartPeriod('solarEnergyChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="solarEnergyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="selfSufficiency">Self-Sufficiency (%)</h3>
                    <select onchange="updateChartPeriod('selfSufficiencyChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="selfSufficiencyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="deviceUsage">Individual Device Total Usage (kWh)</h3>
                    <select onchange="updateChartPeriod('deviceUsageChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="deviceUsageChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="gasConsumption">Gas Consumption (m³)</h3>
                    <select onchange="updateChartPeriod('gasConsumptionChart', this.value)">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <canvas id="gasConsumptionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="modal">
        <h2 data-i18n="userSettings">User Settings</h2>
        <div class="mb-3">
            <label for="username" data-i18n="username">Username:</label>
            <input type="text" id="username" class="form-control" placeholder="Enter your name" data-i18n-placeholder="enterYourName">
        </div>
        <div class="mb-3">
            <label for="theme" data-i18n="theme">Theme:</label>
            <select id="theme" class="form-control">
                <option value="smart-home" data-i18n="smartHomeDashboard">Smart Home Dashboard</option>
                <option value="energy" data-i18n="energyDashboard">Energy Dashboard</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="temp-unit" data-i18n="tempUnit">Temperature Unit:</label>
            <select id="temp-unit" class="form-control">
                <option value="metric" data-i18n="celsius">Celsius (°C)</option>
                <option value="imperial" data-i18n="fahrenheit">Fahrenheit (°F)</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="theme-color" data-i18n="sidebarColor">Sidebar Color:</label>
            <select id="theme-color" class="form-control">
                <option value="#003366" data-i18n="darkTeal">Dark Teal (Default)</option>
                <option value="#0066cc" data-i18n="blue">Blue</option>
                <option value="#006600" data-i18n="green">Green</option>
                <option value="#cc0000" data-i18n="red">Red</option>
                <option value="#660066" data-i18n="purple">Purple</option>
                <option value="#ff6600" data-i18n="orange">Orange</option>
                <option value="#006666" data-i18n="teal">Teal</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="language" data-i18n="language">Language:</label>
            <select id="language" class="form-control" onchange="changeLanguage()">
                <option value="en" data-i18n="english">English</option>
                <option value="es" data-i18n="spanish">Spanish</option>
                <option value="fr" data-i18n="french">French</option>
                <option value="de" data-i18n="german">German</option>
                <option value="ta" data-i18n="tamil">Tamil</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="time-zone" data-i18n="timeZone">Time Zone:</label>
            <select id="time-zone" class="form-control">
                <option value="UTC">UTC</option>
                <option value="America/New_York">Eastern Time (US)</option>
                <option value="Europe/London">GMT (UK)</option>
                <option value="Asia/Kolkata">India Standard Time (IST)</option>
                <option value="Asia/Tokyo">Japan Standard Time</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="background-image" data-i18n="backgroundImage">Background Image (PNG/JPG):</label>
            <input type="file" id="background-image" class="form-control" accept=".png,.jpg,.jpeg">
        </div>
        <div class="mb-3">
            <label for="notification-sound" data-i18n="notificationSound">Notification Sound:</label>
            <input type="checkbox" id="notification-sound"> <span data-i18n="enable">Enable</span>
        </div>
        <div class="mb-3">
            <label for="dark-mode" data-i18n="darkMode">Dark Mode:</label>
            <input type="checkbox" id="dark-mode" onchange="toggleDarkMode()">
        </div>
        <button class="btn btn-primary" onclick="saveSettings()" data-i18n="save">Save</button>
        <button class="btn btn-secondary" onclick="closeModal()" data-i18n="close">Close</button>
    </div>

    <div id="notification-modal" class="modal notification-modal">
        <h3 data-i18n="notifications">Notifications</h3>
        <p id="notification-list">
            Energy usage spike detected at 8:00 AM on Mar 11, 2025<br>
            Solar panel efficiency dropped below 80% at 10:30 AM<br>
            Scheduled maintenance reminder for Mar 15, 2025<br>
            Battery storage at 95% capacity at 11:00 AM<br>
            Grid outage detected from 6:00 AM to 6:15 AM
        </p>
        <button class="btn btn-secondary mt-2" onclick="closeNotificationModal()" data-i18n="close">Close</button>
    </div>

    <div id="search-modal" class="modal small-modal">
        <h2 data-i18n="searchFunctions">Search Functions</h2>
        <input type="text" id="search-input" class="form-control" placeholder="Enter function name" data-i18n-placeholder="enterFunctionName">
        <p id="search-results" class="mt-2">Enter a function name to search...</p>
        <button class="btn btn-primary mt-2" onclick="searchFunctions()" data-i18n="search">Search</button>
        <button class="btn btn-secondary mt-2" onclick="closeSearchModal()" data-i18n="close">Close</button>
    </div>

    <div id="edit-modal" class="modal small-modal">
        <h2 data-i18n="editFunctions">Edit Functions</h2>
        <div class="mb-3">
            <label for="edit-items" data-i18n="items">Items:</label>
            <select id="edit-items" class="form-control">
                <option value="charts">Charts</option>
                <option value="sidebar">Sidebar</option>
                <option value="notifications">Notifications</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="edit-functions" data-i18n="functions">Functions:</label>
            <select id="edit-functions" class="form-control">
                <option value="initCharts">initCharts</option>
                <option value="updateEnergyUsage">updateEnergyUsage</option>
                <option value="toggleSidebar">toggleSidebar</option>
                <option value="toggleNotifications">toggleNotifications</option>
            </select>
        </div>
        <button class="btn btn-primary mt-2" onclick="alert('Edit functionality not implemented yet.')" data-i18n="save">Save</button>
        <button class="btn btn-secondary mt-2" onclick="closeEditModal()" data-i18n="close">Close</button>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModals()"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_KEY = "6644a8f0c69e29249db1d7b68c03e635"; // Replace with your OpenWeatherMap API key
        const deviceUsage = JSON.parse(localStorage.getItem("energyUsage")) || { "AC": 1.5, "Lights": 0.2, "TV": 0.8, "Heater": 2.0, "Fan": 0.5 };
        let notifications = [
            "Energy usage spike detected at 8:00 AM on Mar 11, 2025",
            "Solar panel efficiency dropped below 80% at 10:30 AM",
            "Scheduled maintenance reminder for Mar 15, 2025",
            "Battery storage at 95% capacity at 11:00 AM",
            "Grid outage detected from 6:00 AM to 6:15 AM"
        ];
        let tempUnit = "metric";
        let language = "en";
        let timeZone = "UTC";
        let chartInstances = {}; // Store chart instances

        const translations = {
            en: {
                energyDashboard: "Energy Dashboard", smartHomeAssistant: "Smart Home Assistant", overview: "Overview", energy: "Energy",
                settings: "Settings", notifications: "Notifications", logout: "Logout", userSettings: "User Settings", username: "Username",
                enterYourName: "Enter your name", theme: "Theme", smartHomeDashboard: "Smart Home Dashboard", tempUnit: "Temperature Unit",
                celsius: "Celsius (°C)", fahrenheit: "Fahrenheit (°F)", sidebarColor: "Sidebar Color", darkTeal: "Dark Teal (Default)",
                blue: "Blue", green: "Green", red: "Red", purple: "Purple", orange: "Orange", teal: "Teal", language: "Language",
                english: "English", spanish: "Spanish", french: "French", german: "German", tamil: "Tamil", timeZone: "Time Zone",
                backgroundImage: "Background Image (PNG/JPG)", notificationSound: "Notification Sound", enable: "Enable", darkMode: "Dark Mode",
                save: "Save", close: "Close", electricUsage: "Electric Usage (kWh)", energyDistribution: "Energy Distribution",
                solarProduction: "Solar Production (kWh)", netConsumed: "Net Consumed from Grid (kWh)", selfConsumed: "Self-Consumed Energy (kWh)",
                solarEnergy: "Solar Energy (kWh)", selfSufficiency: "Self-Sufficiency (%)", deviceUsage: "Individual Device Total Usage (kWh)",
                gasConsumption: "Gas Consumption (m³)", searchFunctions: "Search Functions", enterFunctionName: "Enter function name",
                search: "Search", editFunctions: "Edit Functions", items: "Items", functions: "Functions",
                systemCheckCompletedAt: "System check completed at", noNotifications: "No notifications"
            },
            es: {
                energyDashboard: "Tablero de Energía", smartHomeAssistant: "Asistente de Casa Inteligente", overview: "Resumen", energy: "Energía",
                settings: "Configuraciones", notifications: "Notificaciones", logout: "Cerrar sesión", userSettings: "Configuración del usuario",
                username: "Nombre de usuario", enterYourName: "Ingresa tu nombre", theme: "Tema", smartHomeDashboard: "Tablero de Casa Inteligente",
                tempUnit: "Unidad de temperatura", celsius: "Celsius (°C)", fahrenheit: "Fahrenheit (°F)", sidebarColor: "Color de la barra lateral",
                darkTeal: "Turquesa oscuro (predeterminado)", blue: "Azul", green: "Verde", red: "Rojo", purple: "Púrpura", orange: "Naranja",
                teal: "Turquesa", language: "Idioma", english: "Inglés", spanish: "Español", french: "Francés", german: "Alemán", tamil: "Tamil",
                timeZone: "Zona horaria", backgroundImage: "Imagen de fondo (PNG/JPG)", notificationSound: "Sonido de notificación", enable: "Habilitar",
                darkMode: "Modo oscuro", save: "Guardar", close: "Cerrar", electricUsage: "Uso eléctrico (kWh)", energyDistribution: "Distribución de energía",
                solarProduction: "Producción solar (kWh)", netConsumed: "Consumo neto de la red (kWh)", selfConsumed: "Energía autoconsumida (kWh)",
                solarEnergy: "Energía solar (kWh)", selfSufficiency: "Autosuficiencia (%)", deviceUsage: "Uso total por dispositivo (kWh)",
                gasConsumption: "Consumo de gas (m³)", searchFunctions: "Buscar funciones", enterFunctionName: "Ingresa el nombre de la función",
                search: "Buscar", editFunctions: "Editar funciones", items: "Elementos", functions: "Funciones",
                systemCheckCompletedAt: "Comprobación del sistema completada a las", noNotifications: "Sin notificaciones"
            },
            fr: {
                energyDashboard: "Tableau de Bord Énergétique", smartHomeAssistant: "Assistant Maison Intelligente", overview: "Aperçu", energy: "Énergie",
                settings: "Paramètres", notifications: "Notifications", logout: "Déconnexion", userSettings: "Paramètres utilisateur",
                username: "Nom d'utilisateur", enterYourName: "Entrez votre nom", theme: "Thème", smartHomeDashboard: "Tableau de Bord Maison Intelligente",
                tempUnit: "Unité de température", celsius: "Celsius (°C)", fahrenheit: "Fahrenheit (°F)", sidebarColor: "Couleur de la barre latérale",
                darkTeal: "Turquoise foncé (par défaut)", blue: "Bleu", green: "Vert", red: "Rouge", purple: "Violet", orange: "Orange",
                teal: "Turquoise", language: "Langue", english: "Anglais", spanish: "Español", french: "Français", german: "Allemand", tamil: "Tamoul",
                timeZone: "Fuseau horaire", backgroundImage: "Image de fond (PNG/JPG)", notificationSound: "Son de notification", enable: "Activer",
                darkMode: "Mode sombre", save: "Sauvegarder", close: "Fermer", electricUsage: "Consommation électrique (kWh)", energyDistribution: "Distribution d'énergie",
                solarProduction: "Production solaire (kWh)", netConsumed: "Consommation nette du réseau (kWh)", selfConsumed: "Énergie autoconsumée (kWh)",
                solarEnergy: "Énergie solaire (kWh)", selfSufficiency: "Autonomie (%)", deviceUsage: "Usage total par appareil (kWh)",
                gasConsumption: "Consommation de gaz (m³)", searchFunctions: "Rechercher des fonctions", enterFunctionName: "Entrez le nom de la fonction",
                search: "Rechercher", editFunctions: "Modifier les fonctions", items: "Articles", functions: "Fonctions",
                systemCheckCompletedAt: "Vérification du système terminée à", noNotifications: "Aucune notification"
            },
            de: {
                energyDashboard: "Energiedashboard", smartHomeAssistant: "Smart Home Assistent", overview: "Übersicht", energy: "Energie",
                settings: "Einstellungen", notifications: "Benachrichtigungen", logout: "Abmelden", userSettings: "Benutzereinstellungen",
                username: "Benutzername", enterYourName: "Geben Sie Ihren Namen ein", theme: "Thema", smartHomeDashboard: "Smart Home Dashboard",
                tempUnit: "Temperatureinheit", celsius: "Celsius (°C)", fahrenheit: "Fahrenheit (°F)", sidebarColor: "Seitenleistenfarbe",
                darkTeal: "Dunkles Türkis (Standard)", blue: "Blau", green: "Grün", red: "Rot", purple: "Lila", orange: "Orange",
                teal: "Türkis", language: "Sprache", english: "Englisch", spanish: "Spanisch", french: "Französisch", german: "Deutsch", tamil: "Tamil",
                timeZone: "Zeitzone", backgroundImage: "Hintergrundbild (PNG/JPG)", notificationSound: "Benachrichtigungston", enable: "Aktivieren",
                darkMode: "Dunkler Modus", save: "Speichern", close: "Schließen", electricUsage: "Stromverbrauch (kWh)", energyDistribution: "Energiezuteilung",
                solarProduction: "Solarproduktion (kWh)", netConsumed: "Nettoverbrauch aus dem Netz (kWh)", selfConsumed: "Selbstverbrauchte Energie (kWh)",
                solarEnergy: "Solarenergie (kWh)", selfSufficiency: "Selbstversorgung (%)", deviceUsage: "Gesamtverbrauch einzelner Geräte (kWh)",
                gasConsumption: "Gasverbrauch (m³)", searchFunctions: "Funktionen suchen", enterFunctionName: "Funktionsnamen eingeben",
                search: "Suchen", editFunctions: "Funktionen bearbeiten", items: "Elemente", functions: "Funktionen",
                systemCheckCompletedAt: "Systemprüfung abgeschlossen um", noNotifications: "Keine Benachrichtigungen"
            },
            ta: {
                energyDashboard: "ஆற்றல் டாஷ்போர்டு", smartHomeAssistant: "ஸ்மார்ட் ஹோம் உதவியாளர்", overview: "மேலோட்டம்", energy: "ஆற்றல்",
                settings: "அமைப்புகள்", notifications: "அறிவிப்புகள்", logout: "வெளியேறு", userSettings: "பயனர் அமைப்புகள்",
                username: "பயனர்பெயர்", enterYourName: "உங்கள் பெயரை உள்ளிடவும்", theme: "தீம்", smartHomeDashboard: "ஸ்மார்ட் ஹோம் டாஷ்போர்டு",
                tempUnit: "வெப்பநிலை அலகு", celsius: "செல்சியஸ் (°C)", fahrenheit: "பாரன்ஹீட் (°F)", sidebarColor: "பக்கப்பட்டி நிறம்",
                darkTeal: "இருண்ட டீல் (இயல்புநிலை)", blue: "நீலம்", green: "பச்சை", red: "சிவப்பு", purple: "ஊதா", orange: "ஆரஞ்சு",
                teal: "டீல்", language: "மொழி", english: "ஆங்கிலம்", spanish: "ஸ்பானிஷ்", french: "பிரெஞ்சு", german: "ஜெர்மன்", tamil: "தமிழ்",
                timeZone: "நேர மண்டலம்", backgroundImage: "பின்னணி படம் (PNG/JPG)", notificationSound: "அறிவிப்பு ஒலி", enable: "இயக்கு",
                darkMode: "இருண்ட பயன்முறை", save: "சேமி", close: "மூடு", electricUsage: "மின்சார பயன்பாடு (kWh)", energyDistribution: "ஆற்றல் விநியோகம்",
                solarProduction: "சூரிய உற்பத்தி (kWh)", netConsumed: "கட்டமைப்பிலிருந்து நிகர பயன்பாடு (kWh)", selfConsumed: "சுயமாக பயன்படுத்திய ஆற்றல் (kWh)",
                solarEnergy: "சூரிய ஆற்றல் (kWh)", selfSufficiency: "சுயசார்பு (%)", deviceUsage: "தனிப்பட்ட சாதன மொத்த பயன்பாடு (kWh)",
                gasConsumption: "வாயு பயன்பாடு (m³)", searchFunctions: "செயல்பாடுகளை தேடு", enterFunctionName: "செயல்பாட்டு பெயரை உள்ளிடவும்",
                search: "தேடு", editFunctions: "செயல்பாடுகளை திருத்து", items: "பொருட்கள்", functions: "செயல்பாடுகள்",
                systemCheckCompletedAt: "கணினி சோதனை முடிந்தது", noNotifications: "அறிவிப்புகள் இல்லை"
            }
        };

        function initEnergyPage() {
            updateTime();
            setInterval(updateTime, 1000);
            updateLocation();
            initCharts();
            loadSettings();
            updateNotifications();
            adjustLayoutForScreenSize();
        }

        function updateTime() {
            const date = new Date();
            const options = { timeZone: timeZone, hour: 'numeric', minute: '2-digit', second: '2-digit' };
            const timeStr = date.toLocaleTimeString(language, options);
            document.getElementById("header-time").textContent = timeStr;
        }

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    document.getElementById("header-location").textContent = `${data.address.city || data.address.town || ""}, ${data.address.country || ""}`;
                }, () => document.getElementById("header-location").textContent = translations[language]["locationAccessDenied"] || "Location access denied.");
            } else {
                document.getElementById("header-location").textContent = translations[language]["geolocationNotSupported"] || "Geolocation not supported.";
            }
        }

        function destroyCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    delete chartInstances[chartId];
                }
            });
        }

        function generateChartData(period) {
            const now = new Date();
            let labels = [];
            let dataPoints = period === 'daily' ? 24 : period === 'weekly' ? 7 : 30;

            for (let i = 0; i < dataPoints; i++) {
                let date;
                if (period === 'daily') {
                    date = new Date(now.getTime() - (23 - i) * 60 * 60 * 1000);
                    labels.push(date.toLocaleTimeString(language, { hour: '2-digit', minute: '2-digit' }));
                } else if (period === 'weekly') {
                    date = new Date(now.getTime() - (6 - i) * 24 * 60 * 60 * 1000);
                    labels.push(date.toLocaleDateString(language, { weekday: 'short' }));
                } else {
                    date = new Date(now.getTime() - (29 - i) * 24 * 60 * 60 * 1000);
                    labels.push(date.toLocaleDateString(language, { day: 'numeric', month: 'short' }));
                }
            }

            const electricUsageData = labels.map(() => Math.random() * 15);
            const solarProductionData = electricUsageData.map(val => val * 0.5);
            const netConsumedData = electricUsageData.map(val => val * 0.7);
            const selfConsumedData = electricUsageData.map(val => val * 0.3);
            const solarEnergyData = solarProductionData;
            const selfSufficiencyData = electricUsageData.map((val, i) => (val > 0 ? (selfConsumedData[i] / val) * 100 : 0));
            const gasConsumptionData = electricUsageData.map(val => val * 0.2);

            return {
                labels,
                electricUsageData,
                solarProductionData,
                netConsumedData,
                selfConsumedData,
                solarEnergyData,
                selfSufficiencyData,
                gasConsumptionData
            };
        }

        function initCharts() {
            // Initialize all charts with default 'daily' period
            updateChartPeriod('electricUsageChart', 'daily');
            updateChartPeriod('energyDistributionChart', 'daily');
            updateChartPeriod('solarProductionChart', 'daily');
            updateChartPeriod('netConsumedChart', 'daily');
            updateChartPeriod('selfConsumedChart', 'daily');
            updateChartPeriod('solarEnergyChart', 'daily');
            updateChartPeriod('selfSufficiencyChart', 'daily');
            updateChartPeriod('deviceUsageChart', 'daily');
            updateChartPeriod('gasConsumptionChart', 'daily');
        }

        function updateChartPeriod(chartId, period) {
            const data = generateChartData(period);

            // Destroy existing chart if it exists
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
            }

            // Create new chart based on chartId and period
            if (chartId === "electricUsageChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["electricUsage"], data: data.electricUsageData, borderColor: '#007bff', fill: false }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "energyDistributionChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ["Solar", "Grid", "Gas"],
                        datasets: [{ data: [sumArray(data.solarProductionData), sumArray(data.netConsumedData), sumArray(data.gasConsumptionData)], backgroundColor: ['#28a745', '#dc3545', '#ffc107'] }]
                    },
                    options: { responsive: true }
                });
            } else if (chartId === "solarProductionChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'bar',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["solarProduction"], data: data.solarProductionData, backgroundColor: '#28a745' }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "netConsumedChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["netConsumed"], data: data.netConsumedData, borderColor: '#dc3545', fill: false }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "selfConsumedChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'bar',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["selfConsumed"], data: data.selfConsumedData, backgroundColor: '#17a2b8' }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "solarEnergyChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["solarEnergy"], data: data.solarEnergyData, borderColor: '#28a745', fill: false }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "selfSufficiencyChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["selfSufficiency"], data: data.selfSufficiencyData, borderColor: '#ffc107', fill: false }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            } else if (chartId === "deviceUsageChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(deviceUsage),
                        datasets: [{ label: translations[language]["deviceUsage"], data: Object.values(deviceUsage), backgroundColor: '#007bff' }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else if (chartId === "gasConsumptionChart") {
                chartInstances[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{ label: translations[language]["gasConsumption"], data: data.gasConsumptionData, borderColor: '#ffc107', fill: false }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        function sumArray(arr) {
            return arr.reduce((a, b) => a + b, 0);
        }

        function showSection() {
            // No-op for energy page
        }

        function showHomePage(event) {
            event.preventDefault();
            localStorage.setItem("showDashboard", "true");
            window.location.href = "index.html";
        }

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const content = document.getElementById("dashboard-content");
            sidebar.classList.toggle("minimized");
            content.classList.toggle("minimized");
            if (window.innerWidth > 768) {
                sidebar.style.width = sidebar.classList.contains("minimized") ? "60px" : "250px";
                content.style.marginLeft = sidebar.classList.contains("minimized") ? "60px" : "270px";
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        }

        function changeLanguage() {
            language = document.getElementById("language").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                el.textContent = translations[language][el.getAttribute("data-i18n")] || el.textContent;
            });
            document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
                el.placeholder = translations[language][el.getAttribute("data-i18n-placeholder")] || el.placeholder;
            });
            initCharts();
            updateNotifications();
        }

        function saveSettings() {
            const username = document.getElementById("username").value;
            const theme = document.getElementById("theme").value;
            const tempUnitSetting = document.getElementById("temp-unit").value;
            const themeColor = document.getElementById("theme-color").value;
            const languageSetting = document.getElementById("language").value;
            const timeZoneSetting = document.getElementById("time-zone").value;
            const notificationSound = document.getElementById("notification-sound").checked;
            const darkMode = document.getElementById("dark-mode").checked;
            const backgroundImage = document.getElementById("background-image").files[0];

            if (username) {
                localStorage.setItem("username", username);
                localStorage.setItem("theme", theme);
                localStorage.setItem("tempUnit", tempUnitSetting);
                localStorage.setItem("themeColor", themeColor);
                localStorage.setItem("language", languageSetting);
                localStorage.setItem("timeZone", timeZoneSetting);
                localStorage.setItem("notificationSound", notificationSound);
                localStorage.setItem("darkMode", darkMode);
                tempUnit = tempUnitSetting;
                language = languageSetting;
                timeZone = timeZoneSetting;

                if (backgroundImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        localStorage.setItem("backgroundImage", e.target.result);
                        document.body.style.background = `url(${e.target.result}) no-repeat center center fixed`;
                        document.body.style.backgroundSize = "cover";
                        document.querySelectorAll(".modal").forEach(modal => {
                            modal.style.background = `rgba(255, 255, 255, 0.9) url(${e.target.result}) no-repeat center center fixed`;
                            modal.style.backgroundSize = "cover";
                        });
                    };
                    reader.readAsDataURL(backgroundImage);
                }

                applyThemeSettings();
                initCharts();
                updateTime();
                alert(translations[language]["settingsSaved"] || "Settings saved successfully!");
                closeModal();
            }
        }

        function applyThemeSettings() {
            const theme = localStorage.getItem("theme") || "smart-home";
            const themeColor = localStorage.getItem("themeColor") || "#003366";
            const darkMode = localStorage.getItem("darkMode") === "true";
            document.body.classList.remove("energy-theme", "dark-mode");
            if (theme === "energy") document.body.classList.add("energy-theme");
            if (darkMode) document.body.classList.add("dark-mode");
            document.querySelector(".ha-sidebar").style.backgroundColor = themeColor;
        }

        function loadSettings() {
            const storedUsername = localStorage.getItem("username");
            if (storedUsername) document.getElementById("username").value = storedUsername;
            document.getElementById("theme").value = localStorage.getItem("theme") || "smart-home";
            document.getElementById("temp-unit").value = localStorage.getItem("tempUnit") || "metric";
            document.getElementById("theme-color").value = localStorage.getItem("themeColor") || "#003366";
            document.getElementById("language").value = localStorage.getItem("language") || "en";
            document.getElementById("time-zone").value = localStorage.getItem("timeZone") || "UTC";
            document.getElementById("notification-sound").checked = localStorage.getItem("notificationSound") !== "false";
            document.getElementById("dark-mode").checked = localStorage.getItem("darkMode") === "true";
            const storedBackground = localStorage.getItem("backgroundImage");
            if (storedBackground) {
                document.body.style.background = `url(${storedBackground}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                document.querySelectorAll(".modal").forEach(modal => {
                    modal.style.background = `rgba(255, 255, 255, 0.9) url(${storedBackground}) no-repeat center center fixed`;
                    modal.style.backgroundSize = "cover";
                });
            }
            tempUnit = localStorage.getItem("tempUnit") || "metric";
            language = localStorage.getItem("language") || "en";
            timeZone = localStorage.getItem("timeZone") || "UTC";
            applyThemeSettings();
            changeLanguage();
        }

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem("username");
                localStorage.removeItem("password");
                localStorage.removeItem("showDashboard");
                window.location.href = "index.html";
            }
        }

        function addNotification(message) {
            notifications.unshift(message);
            if (notifications.length > 5) notifications.pop();
            updateNotifications();
        }

        function updateNotifications() {
            const notificationList = document.getElementById("notification-list");
            notificationList.innerHTML = notifications.length > 0 ? notifications.join("<br>") : translations[language]["noNotifications"] || "No notifications";
        }

        function toggleNotifications() {
            const modal = document.getElementById("notification-modal");
            const overlay = document.getElementById("modal-overlay");
            if (modal.style.display !== "block") {
                addNotification(`${translations[language]["systemCheckCompletedAt"]} ${new Date().toLocaleTimeString(language, { timeZone: timeZone })}`);
                modal.style.display = "block";
                overlay.style.display = "block";
            } else {
                modal.style.display = "none";
                overlay.style.display = "none";
            }
        }

        function closeNotificationModal() {
            document.getElementById("notification-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }

        function showSearchModal() {
            document.getElementById("search-modal").style.display = "block";
            document.getElementById("modal-overlay").style.display = "block";
            document.getElementById("search-input").value = "";
            document.getElementById("search-results").textContent = translations[language]["enterFunctionName"] || "Enter a function name to search...";
        }

        function closeSearchModal() {
            document.getElementById("search-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }

        function searchFunctions() {
            const query = document.getElementById("search-input").value.toLowerCase();
            const functions = [
                "toggleDevice", "toggleLight", "toggleDoor", "updateThermostat", "addTask", "deleteTask",
                "simulateSecurity", "fetchWeatherAndForecast", "updateEnergyUsage", "initCharts"
            ];
            const results = functions.filter(f => f.toLowerCase().includes(query));
            document.getElementById("search-results").textContent = results.length > 0 ? results.join(", ") : translations[language]["noFunctionsFound"] || "No functions found.";
        }

        function showEditModal() {
            document.getElementById("edit-modal").style.display = "block";
            document.getElementById("modal-overlay").style.display = "block";
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }

        function closeModals() {
            document.getElementById("settings-modal").style.display = "none";
            document.getElementById("notification-modal").style.display = "none";
            document.getElementById("search-modal").style.display = "none";
            document.getElementById("edit-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }

        function showSettings() {
            document.getElementById("settings-modal").style.display = "block";
            document.getElementById("modal-overlay").style.display = "block";
            loadSettings();
        }

        function closeModal() {
            document.getElementById("settings-modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";
        }

        // Dummy function for layout adjustment (not fully implemented in original code)
        function adjustLayoutForScreenSize() {
            // Add any layout adjustments if needed
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("minimize-sidebar").addEventListener("click", toggleSidebar);
        });
    </script>
</body>
</html>